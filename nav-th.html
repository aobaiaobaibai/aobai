<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é³Œæ‹œ | à¸—à¸”à¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸¡à¸´à¹€à¸£à¸­à¸£à¹Œ | à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸¡à¸´à¹€à¸£à¸­à¸£à¹Œà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰</title>
  <style>
    :root {
      --primary-color: #893a56;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --danger-color: #f44336;
      --text-color: #333;
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;
      --border-radius: 8px;
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: var(--transition);
      line-height: 1.6;
    }

    .dark-mode {
      --primary-color: #b34d6a;
      --text-color: #f5f5f5;
      --bg-color: #2d2d2d;
      --card-bg: #3d3d3d;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logo {
      width: 40px;
      height: 40px;
      transition: var(--transition);
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .toggle-buttons {
      display: flex;
      gap: 12px;
    }

    .language-selector {
      margin-right: 12px;
    }

    .language-selector select {
      padding: 8px 12px;
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .language-selector select:hover {
      border-color: var(--primary-color);
      background-color: rgba(137, 58, 86, 0.05);
    }

    #toggle-container button {
      padding: 8px 16px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    #toggle-container button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    #title {
      font-size: 28px;
      margin: 20px 0;
      color: var(--primary-color);
      font-weight: 600;
    }

    #status-main {
      font-size: 1em;
      margin-bottom: 20px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .result-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 20px 0;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .result-table th, .result-table td {
      padding: 12px;
      text-align: center;
      border: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .dark-mode .result-table th, 
    .dark-mode .result-table td {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .result-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    .result-table tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    .dark-mode .result-table tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 auto;
    }
    
    .status-available {
      background-color: var(--success-color);
      box-shadow: 0 0 6px rgba(76, 175, 80, 0.4);
    }
    
    .status-unavailable {
      background-color: var(--danger-color);
      box-shadow: 0 0 6px rgba(244, 67, 54, 0.4);
    }
    
    .status-resolving {
      background-color: #ff9800;
      box-shadow: 0 0 6px rgba(255, 152, 0, 0.4);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .button {
      padding: 8px 16px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      margin: 4px;
    }

    .enabled {
      background-color: var(--primary-color);
      color: white;
    }

    .enabled:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .disabled {
      background-color: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
    }

    .dark-mode .disabled {
      background-color: #555;
      color: #888;
    }

    #footer {
      margin-top: 40px;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
    }

    #footer a {
      color: var(--primary-color);
      text-decoration: none;
      transition: var(--transition);
    }

    #footer a:hover {
      text-decoration: underline;
    }

    .countdown {
      display: inline-block;
      min-width: 1em;
      font-weight: bold;
      color: var(--primary-color);
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      
      .result-table {
        font-size: 14px;
      }
      
      .result-table th, .result-table td {
        padding: 8px;
      }
      
      #title {
        font-size: 24px;
      }
    }


  </style>
</head>
<body>
  <div id="main-content">
    <div class="container">
      <div id="toggle-container">
        <div class="logo">
          <img src="images/uim-logo_128x128_homepage.png" alt="Logo">
        </div>
        <div class="toggle-buttons">
          <div class="language-selector">
            <select id="languageSelect" onchange="switchLanguage()">
              <option value="zh-CN" selected>ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
              <option value="zh-TW">ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡</option>
              <option value="en">ğŸ‡ºğŸ‡¸ English</option>
              <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
              <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
              <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
              <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
              <option value="ms">ğŸ‡²ğŸ‡¾ Bahasa Melayu</option>
              <option value="id">ğŸ‡®ğŸ‡© Bahasa Indonesia</option>
              <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
            </select>
          </div>
          <button id="theme-toggle">à¹‚à¸«à¸¡à¸”à¸¡à¸·à¸”</button>
        </div>
      </div>
      <h2 id="title">æ­£åœ¨æµ‹é€Ÿ...</h2>
      <div id="status-main"></div>
      <table class="result-table" id="speedTable">
        <tr>
          <th id="header-mirror">é•œåƒç«™</th>
          <th id="header-category">çŠ¶æ€</th>
          <th id="header-action">æ“ä½œ</th>
          <th id="header-link">é“¾æ¥</th>
        </tr>
      </table>
      <div id="footer">
        <a href="https://github.com/aobaiaobaibai/aobai" target="_blank">GitHub - à¸«à¸²à¸—à¸²à¸‡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™</a> |
        <a href="##" target="_blank">à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¸‹à¸´à¸™à¹€à¸ˆà¸µà¸¢à¸‡ à¸—à¸´à¹€à¸šà¸• à¸Šà¸´à¸‡à¹„à¸«à¹ˆ à¸«à¸™à¸´à¸‡à¹€à¸‹à¸µà¸¢à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡ à¸‚à¸­à¸­à¸ à¸±à¸¢à¸­à¸¢à¹ˆà¸²à¸‡à¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡!</a>
      </div>
    </div>
  </div>
  <script>
    // è¯­è¨€æ–‡ä»¶æ˜ å°„
    const languageFiles = {
      'zh-CN': 'nav.html',
      'zh-TW': 'nav-tw.html',
      'en': 'nav-en.html',
      'ja': 'nav-ja.html',
      'ko': 'nav-ko.html',
      'ru': 'nav-ru.html',
      'th': 'nav-th.html',
      'ms': 'nav-ms.html',
      'id': 'nav-id.html',
      'vi': 'nav-vi.html'
    };

    // åˆ‡æ¢è¯­è¨€å‡½æ•°
    function switchLanguage() {
      const selectedLang = document.getElementById('languageSelect').value;
      const targetFile = languageFiles[selectedLang];
      
      // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€
      localStorage.setItem('preferredLanguage', selectedLang);
      
      // è·³è½¬åˆ°å¯¹åº”è¯­è¨€ç‰ˆæœ¬
      if (targetFile && targetFile !== window.location.pathname.split('/').pop()) {
        window.location.href = targetFile;
      }
    }

    // è‡ªåŠ¨æ£€æµ‹è¯­è¨€å¹¶è®¾ç½®
    function detectAndSetLanguage() {
      // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¹‹å‰é€‰æ‹©çš„è¯­è¨€
      let preferredLang = localStorage.getItem('preferredLanguage');
      
      // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åå¥½ï¼Œæ£€æµ‹æµè§ˆå™¨è¯­è¨€
      if (!preferredLang) {
        const browserLang = navigator.language || navigator.languages[0];
        
        // è¯­è¨€æ˜ å°„
        if (browserLang.startsWith('zh-TW') || browserLang.startsWith('zh-HK')) {
          preferredLang = 'zh-TW';
        } else if (browserLang.startsWith('en')) {
          preferredLang = 'en';
        } else if (browserLang.startsWith('ja')) {
          preferredLang = 'ja';
        } else if (browserLang.startsWith('ko')) {
          preferredLang = 'ko';
        } else if (browserLang.startsWith('ru')) {
          preferredLang = 'ru';
        } else if (browserLang.startsWith('th')) {
          preferredLang = 'th';
        } else if (browserLang.startsWith('ms')) {
          preferredLang = 'ms';
        } else if (browserLang.startsWith('id')) {
          preferredLang = 'id';
        } else if (browserLang.startsWith('vi')) {
          preferredLang = 'vi';
        } else {
          preferredLang = 'zh-CN'; // é»˜è®¤ç®€ä½“ä¸­æ–‡
        }
      }
      
      // è®¾ç½®é€‰æ‹©å™¨çš„å€¼
      const selector = document.getElementById('languageSelect');
      if (selector) {
        selector.value = preferredLang;
        
        // å¦‚æœå½“å‰é¡µé¢ä¸æ˜¯ç”¨æˆ·åå¥½çš„è¯­è¨€ï¼Œè‡ªåŠ¨è·³è½¬
        const currentFile = window.location.pathname.split('/').pop() || 'nav.html';
        const targetFile = languageFiles[preferredLang];
        
        if (targetFile && targetFile !== currentFile && !sessionStorage.getItem('languageDetected')) {
          sessionStorage.setItem('languageDetected', 'true');
          window.location.href = targetFile;
        }
      }
    }

    // ä»¥ä¸‹ä¸ºæµ‹é€Ÿé¡µé¢åŸæœ‰é€»è¾‘
    let currentLanguage = "zh";
    let isDarkMode = false;
    let userInteracted = false;
    let autoRedirectTimeout = null;
    let autoRedirectDone = false;

    // æ£€æµ‹æµè§ˆå™¨è¯­è¨€
    function detectLanguage() {
      const browserLang = navigator.language || navigator.userLanguage;
      if (browserLang.startsWith('zh')) {
        return "zh";
      } else {
        return "en";
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹é€Ÿ
    window.onload = function() {
      // è‡ªåŠ¨æ£€æµ‹è¯­è¨€å¹¶è®¾ç½®
      detectAndSetLanguage();
      // è‡ªåŠ¨æ£€æµ‹è¯­è¨€
      currentLanguage = detectLanguage();
      updateButtonTexts();
      renderTable(); // ç«‹å³æ¸²æŸ“è¡¨æ ¼ä»¥åº”ç”¨è¯­è¨€
      autoTestAll();
    };

    const translations = {

      zh: {
        title: "à¸à¸³à¸¥à¸±à¸‡à¸—à¸”à¸ªà¸­à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡...",
        bestRouteFound: "à¸à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” à¸ˆà¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™ <span class=\"countdown\">5</span> à¸§à¸´à¸™à¸²à¸—à¸µ!",
        allUnavailable: "à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸£à¸·à¸­à¸‚à¹ˆà¸²à¸¢à¹à¸¥à¸°à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ!",
        dnsResolving: "à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚ DNS à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ...",
        retryHint: "à¸«à¸²à¸à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š",
        tableHeaders: { mirror: "à¸¡à¸´à¹€à¸£à¸­à¸£à¹Œ", category: "à¸ªà¸–à¸²à¸™à¸°", action: "à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£", link: "à¸¥à¸´à¸‡à¸à¹Œ" },
        testSpeedText: "à¸—à¸”à¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§",
        visitText: "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸Šà¸¡",
        waitingText: seconds => `à¸—à¸”à¸ªà¸­à¸š (${seconds}s)`,
        unavailable: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰",
        resolving: "à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚..."
      },
      en: {
        title: "à¸à¸³à¸¥à¸±à¸‡à¸—à¸”à¸ªà¸­à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡...",
        bestRouteFound: "à¸à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” à¸ˆà¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™ <span class=\"countdown\">5</span> à¸§à¸´à¸™à¸²à¸—à¸µ!",
        allUnavailable: "à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸£à¸·à¸­à¸‚à¹ˆà¸²à¸¢à¹à¸¥à¸°à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ!",
        dnsResolving: "à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚ DNS à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ...",
        retryHint: "à¸«à¸²à¸à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š",
        tableHeaders: { mirror: "à¸¡à¸´à¹€à¸£à¸­à¸£à¹Œ", category: "à¸ªà¸–à¸²à¸™à¸°", action: "à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£", link: "à¸¥à¸´à¸‡à¸à¹Œ" },
        testSpeedText: "à¸—à¸”à¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§",
        visitText: "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸Šà¸¡",
        waitingText: seconds => `à¸—à¸”à¸ªà¸­à¸š (${seconds}s)`,
        unavailable: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰",
        resolving: "à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚..."
      }
    
    };

const sites = [
      { name: { zh: "é•œåƒç«™4", en: "Mirror 4" }, encoded: "aHR0cHM6Ly9ib29ranNvbi5vcmc=", lastClicked: 0, time: null, retryCount: 0 },
      { name: { zh: "é•œåƒç«™5", en: "Mirror 5" }, encoded: "aHR0cHM6Ly9ib29rZmVlZC5vcmc=", lastClicked: 0, time: null, retryCount: 0 }
    ];

    const cooldownPeriod = 10000;
    const maxRetries = 2; // æœ€å¤§é‡è¯•æ¬¡æ•°
    const dnsTimeout = 5000; // DNSè§£æè¶…æ—¶æ—¶é—´

    function getSpeedCategory(time, isResolving = false) {
      if (isResolving) {
        return { html: '<div class="status-dot status-resolving"></div>', available: false };
      }
      if (typeof time !== "number")
        return { html: '<div class="status-dot status-unavailable"></div>', available: false };
      return { html: '<div class="status-dot status-available"></div>', available: true };
    }

    function testSpeed(site, isRetry = false) {
      if (site.lastClicked && (Date.now() - site.lastClicked < cooldownPeriod) && !isRetry)
        return;
      
      if (!isRetry) {
        site.lastClicked = Date.now();
        site.retryCount = 0;
      }
      
      // è®¾ç½®è§£æçŠ¶æ€
      site.isResolving = true;
      site.time = translations[currentLanguage].resolving;
      renderTable();
      
      let start = performance.now();
      let img = new Image();
      let finished = false;
      
      // ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼Œç»™DNSè§£ææ›´å¤šæ—¶é—´
      let timer = setTimeout(() => {
        if (!finished) {
          finished = true;
          site.isResolving = false;
          
          // å¦‚æœæ˜¯DNSè§£æé—®é¢˜ï¼Œå°è¯•é‡è¯•
          if (site.retryCount < maxRetries) {
            site.retryCount++;
            setTimeout(() => testSpeed(site, true), 1000); // 1ç§’åé‡è¯•
          } else {
            site.time = translations[currentLanguage].unavailable;
            renderTable();
          }
        }
      }, dnsTimeout);
      
      img.onload = img.onerror = function() {
        if (!finished) {
          clearTimeout(timer);
          finished = true;
          site.isResolving = false;
          
          let t = parseFloat((performance.now() - start).toFixed(2));
          if (t > dnsTimeout) {
            // å¦‚æœå“åº”æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½æ˜¯DNSé—®é¢˜ï¼Œå°è¯•é‡è¯•
            if (site.retryCount < maxRetries) {
              site.retryCount++;
              setTimeout(() => testSpeed(site, true), 1000);
            } else {
              site.time = translations[currentLanguage].unavailable;
            }
          } else {
            site.time = t;
          }
          renderTable();
        }
      };
      
      img.src = atob(site.encoded) + "/favicon.png?_=" + Math.random();
    }

    function startCountdown(element, seconds, callback) {
      let count = seconds;
      const countdownElement = element.querySelector('.countdown');
      
      const timer = setInterval(() => {
        count--;
        if (countdownElement) {
          countdownElement.textContent = count;
        }
        
        if (count <= 0) {
          clearInterval(timer);
          if (callback) callback();
        }
      }, 1000);
    }

    function renderTable() {
      document.getElementById("title").innerText = translations[currentLanguage].title;
      const table = document.getElementById("speedTable");
      table.innerHTML = `<tr>
          <th>${translations[currentLanguage].tableHeaders.mirror}</th>
          <th>${translations[currentLanguage].tableHeaders.category}</th>
          <th>${translations[currentLanguage].tableHeaders.action}</th>
          <th>${translations[currentLanguage].tableHeaders.link}</th>
      </tr>`;
      sites.sort((a, b) => {
        if (typeof a.time === "number" && typeof b.time === "number") return a.time - b.time;
        if (typeof a.time === "number") return -1;
        if (typeof b.time === "number") return 1;
        return 0;
      });
      sites.forEach(site => {
        const row = table.insertRow();
        row.insertCell(0).innerText = site.name[currentLanguage];
        const category = getSpeedCategory(site.time, site.isResolving);
        const statusCell = row.insertCell(1);
        statusCell.innerHTML = category.html;
        statusCell.style.textAlign = 'center';
        const actionCell = row.insertCell(2);
        const testButton = document.createElement("button");
        let remaining = 0;
        if (site.lastClicked && (Date.now() - site.lastClicked < cooldownPeriod)) {
          remaining = Math.ceil((cooldownPeriod - (Date.now() - site.lastClicked)) / 1000);
          testButton.disabled = true;
          testButton.className = "button disabled";
          testButton.innerText = translations[currentLanguage].waitingText(remaining);
        } else {
          testButton.disabled = false;
          testButton.className = "button enabled";
          testButton.innerText = translations[currentLanguage].testSpeedText;
        }
        testButton.onclick = () => { testSpeed(site); };
        actionCell.appendChild(testButton);
        const linkCell = row.insertCell(3);
        const visitButton = document.createElement("button");
        visitButton.innerText = translations[currentLanguage].visitText;
        visitButton.className = "button enabled";
        visitButton.onclick = (event) => {
          if (event.isTrusted) {
            // æ˜¾æ€§è·³è½¬ï¼šç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€ç›®æ ‡ç½‘ç«™
            window.open(atob(site.encoded), "_blank");
          } else {
            alert(currentLanguage === "zh" ? "è¯·æ‰‹åŠ¨ç‚¹å‡»é“¾æ¥" : "Please click the link manually");
          }
        };
        linkCell.appendChild(visitButton);
      });
      const statusDiv = document.getElementById("status-main");
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è§£æçš„ç«™ç‚¹
      const hasResolving = sites.some(site => site.isResolving);
      const hasAvailable = sites.some(site => typeof site.time === "number");
      const allUnavailable = sites.every(site => !site.isResolving && typeof site.time !== "number");
      
      if (hasAvailable) {
        // æœ‰å¯ç”¨ç«™ç‚¹
        statusDiv.innerHTML = translations[currentLanguage].bestRouteFound;
        if (!autoRedirectDone && !autoRedirectTimeout && !userInteracted) {
          startCountdown(statusDiv, 5, () => {
            if (!userInteracted && !autoRedirectDone) {
              // æ˜¾æ€§è·³è½¬ï¼šç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€ç›®æ ‡ç½‘ç«™
              window.open(atob(sites[0].encoded), "_blank");
              autoRedirectDone = true;
            }
            statusDiv.innerText = "";
          });
        }
      } else if (hasResolving) {
        // æœ‰ç«™ç‚¹æ­£åœ¨è§£æDNS
        statusDiv.innerHTML = translations[currentLanguage].dnsResolving + "<br><small>" + translations[currentLanguage].retryHint + "</small>";
        if (autoRedirectTimeout) {
          clearTimeout(autoRedirectTimeout);
          autoRedirectTimeout = null;
        }
      } else if (allUnavailable) {
        // æ‰€æœ‰ç«™ç‚¹éƒ½ä¸å¯ç”¨
        statusDiv.innerText = translations[currentLanguage].allUnavailable;
        if (autoRedirectTimeout) {
          clearTimeout(autoRedirectTimeout);
          autoRedirectTimeout = null;
        }
      }
    }

    function autoTestAll() {
      // å»¶è¿Ÿå¯åŠ¨ï¼Œç»™DNSè§£ææ›´å¤šæ—¶é—´
      setTimeout(() => {
        sites.forEach((site, index) => {
          // é”™å¼€å¯åŠ¨æ—¶é—´ï¼Œé¿å…åŒæ—¶è§£æå¤šä¸ªåŸŸå
          setTimeout(() => {
            testSpeed(site);
          }, index * 500); // æ¯ä¸ªç«™ç‚¹é—´éš”500mså¯åŠ¨
        });
      }, 1000); // é¡µé¢åŠ è½½1ç§’åå¼€å§‹æµ‹é€Ÿ
    }

    document.addEventListener("click", function(e) {
      if (e.target.tagName.toLowerCase() === "button") {
        userInteracted = true;
        if (autoRedirectTimeout) {
          clearTimeout(autoRedirectTimeout);
          autoRedirectTimeout = null;
          document.getElementById("status-main").innerText = "";
        }
      }
    });

    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    function updateButtonTexts() {
      document.getElementById("theme-toggle").innerText = isDarkMode ? "à¹‚à¸«à¸¡à¸”à¸ªà¸§à¹ˆà¸²à¸‡" : "à¹‚à¸«à¸¡à¸”à¸¡à¸·à¸”";
    }

    document.getElementById("theme-toggle").onclick = () => {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle("dark-mode");
      updateButtonTexts();
    };

    setInterval(renderTable, 1000);


  </script>
</body>
</html>

